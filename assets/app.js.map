{"version":3,"file":"app.js","sources":["app.raw.js","../node_modules/unfetch/dist/unfetch.es.js"],"sourcesContent":["import './app.raw.css';\nimport fetch from 'unfetch';\n\nconst color = '#14B7F4';\n\nif (!mapboxgl.supported()) {\n  alert(\"Hi sorry, looks like your browser is not supported to render the map 😢.\\n\\nYou could try to load this site on another (latest) browser perhaps? 🙏\");\n}\n\nmapboxgl.accessToken = 'pk.eyJ1IjoiY2hlZWF1biIsImEiOiJjaXhmb3o3bTEwMDAzMnRudTJuNjh1eXQ1In0.yO6WeKJwx6yIPoVx5aPavQ';\n\nconst map = new mapboxgl.Map({\n  container: 'map',\n  style: 'mapbox://styles/cheeaun/cixol8ezg002g2rqs007w3jmt',\n  maxZoom: 14,\n  logoPosition: 'top-right',\n  attributionControl: false,\n  pitchWithRotate: false,\n  dragRotate: false,\n  boxZoom: false,\n  zoom: 0.1,\n});\nmap.touchZoomRotate.disableRotation();\n\nconst $info = document.getElementById('info');\nconst $infoCountries = document.getElementById('info-countries');\nconst $infoPlaces = document.getElementById('info-places');\nconst $infoCheckins = document.getElementById('info-checkins');\nconst $countries = document.getElementById('countries');\n\nconst bodyClass = document.body.classList;\nfunction startInteractive(){\n  bodyClass.add('interactive');\n}\nmap.on('dragstart', startInteractive);\nmap.on('zoomstart', startInteractive);\n\nfunction endInteractive(){\n  bodyClass.remove('interactive');\n}\n$countries.addEventListener('touchstart', endInteractive, false);\n$countries.addEventListener('mouseenter', endInteractive);\n\nfunction toggleInteractive(){\n  bodyClass.toggle('interactive');\n}\nmap.on('click', toggleInteractive);\n\nconst numberWithCommas = x => x.toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, ',');\n\nmap.addControl(new mapboxgl.AttributionControl({ compact: true }), 'top-right');\n\nclass LayersControl {\n  onAdd(map) {\n    const container = document.createElement('div');\n    container.className = 'mapboxgl-ctrl mapboxgl-ctrl-group';\n\n    const linesButton = document.createElement('button');\n    linesButton.innerHTML = `<svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\">\n      <path d=\"M23 8c0 1.1-.9 2-2 2-.18 0-.35-.02-.5-.07l-3.57 3.55c.05.16.07.34.07.52 0 1.1-.9 2-2 2s-2-.9-2-2c0-.18.02-.36.07-.52l-2.55-2.55c-.16.05-.34.07-.52.07s-.36-.02-.52-.07L4.93 15.5c.05.15.07.32.07.5 0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2c.18 0 .35.02.5.07l4.57-4.55C8.02 9.36 8 9.18 8 9c0-1.1.9-2 2-2s2 .9 2 2c0 .18-.02.36-.07.52l2.55 2.55c.16-.05.34-.07.52-.07s.36.02.52.07l3.55-3.56c-.05-.14-.07-.3-.07-.5 0-1.1.9-2 2-2s2 .9 2 2z\"/>\n    </svg>`;\n    linesButton.type = 'button';\n    linesButton.title = 'Show/hide journey lines';\n    linesButton.addEventListener('click', () => {\n      const visibility = map.getLayoutProperty('lines', 'visibility');\n      if (visibility === 'visible') {\n        map.setLayoutProperty('lines', 'visibility', 'none');\n        linesButton.classList.remove('active');\n      } else {\n        map.setLayoutProperty('lines', 'visibility', 'visible');\n        linesButton.classList.add('active');\n      }\n    }, false);\n\n    container.appendChild(linesButton);\n    return container;\n  }\n}\nmap.addControl(new LayersControl(), 'top-right');\n\nmap.addControl(new mapboxgl.NavigationControl(), 'top-right');\n\nfunction renderNumber(el, number) {\n  const frames = 60;\n  const inc = Math.ceil(number / frames);\n  let num = 0;\n  function render() {\n    if (num >= number) return;\n    num = num + inc;\n    if (num > number) num = number;\n    el.textContent = numberWithCommas(num);\n    requestAnimationFrame(render);\n  }\n  requestAnimationFrame(render);\n};\n\nPromise.all([\n  new Promise((resolve, reject) => {\n    map.on('load', resolve);\n    map.on('error', reject);\n  }),\n  fetch('data/checkins.min.geojson').then((data) => data.json()),\n]).then(([_, data]) => {\n  const _countries = {};\n  const _places = {};\n\n  const checkinsCount = data.features.length;\n\n  const lines = [];\n\n  data.features = data.features.filter((f, i) => {\n    const { id, country } = f.properties;\n    const isUnique = !_places[id];\n    const [lat, lng] = f.geometry.coordinates;\n    if (isUnique) {\n      if (!_countries[country]) {\n        const cc = f.properties.cc.toLowerCase();\n        _countries[country] = {\n          cc: cc,\n          bounds: new mapboxgl.LngLatBounds(),\n          places_count: 0,\n          checkins_count: 0,\n        };\n      }\n      _countries[country].bounds.extend([lat, lng]);\n      _countries[country].places_count++;\n      _places[id] = true;\n    }\n    _countries[country].checkins_count++;\n\n    const nextFeature = data.features[i+1];\n    if (nextFeature && f.properties.date === nextFeature.properties.date){\n      let [ nextLat, nextLng ] = nextFeature.geometry.coordinates;\n      // Magic below from https://github.com/mapbox/mapbox-gl-js/issues/3250#issuecomment-294887678\n      // This make sure the lines can cross the 180th meridian\n      nextLat += nextLat - lat > 180 ? -360 : lat - nextLat > 180 ? 360 : 0;\n      lines.push([[lat, lng], [nextLat, nextLng]]);\n    }\n\n    return isUnique;\n  });\n\n  const placesCount = Object.keys(_places).length;\n\n  const countries = Object.keys(_countries).map((country) => {\n    const c = _countries[country];\n    return {\n      name: country,\n      cc: c.cc,\n      bounds: c.bounds,\n      places_count: c.places_count,\n      checkins_count: c.checkins_count,\n    };\n  });\n\n  const countriesCount = countries.length;\n\n  countries.sort((a, b) => b.checkins_count - a.checkins_count);\n  countries.forEach((country, i) => {\n    const { cc, name, bounds, checkins_count, places_count } = country;\n    const $button = document.createElement('button');\n    $button.type = 'button';\n    $button.addEventListener('click', (e) => {\n      map.fitBounds(bounds, { padding: 150 });\n    }, false);\n    $button.innerHTML = `\n      <img src=\"data/countries/${cc}.svg\" width=\"50\" height=\"50\" alt=\"\"><br>\n      <b>${name}</b>\n      <br>\n      ${numberWithCommas(checkins_count)} check-in${checkins_count > 1 ? 's' : ''}\n      <br>\n      ${numberWithCommas(places_count)} place${places_count > 1 ? 's' : ''}\n    `;\n    $countries.appendChild($button);\n  });\n\n  map.addSource('checkins', {\n    type: 'geojson',\n    data: data,\n    cluster: true,\n    clusterMaxZoom: 10,\n    clusterRadius: 10,\n  });\n\n  map.addLayer({\n    id: 'cluster',\n    type: 'circle',\n    source: 'checkins',\n    filter: ['has', 'point_count'],\n    paint: {\n      'circle-radius': {\n        property: 'point_count',\n        stops: [\n          [{zoom: 0, value: 3}, 7],\n          [{zoom: 0, value: 10}, 10],\n          [{zoom: 0, value: 100}, 13],\n          [{zoom: 0, value: 200}, 16],\n        ],\n      },\n      'circle-color': color,\n      'circle-opacity': .9,\n      'circle-stroke-width': {\n        property: 'point_count',\n        stops: [\n          [3, 3],\n          [50, 6],\n        ],\n      },\n      'circle-stroke-color': color,\n      'circle-stroke-opacity': .3,\n    }\n  });\n\n  map.addLayer({\n    id: 'checkins-count',\n    type: 'symbol',\n    source: 'checkins',\n    filter: ['has', 'point_count'],\n    maxzoom: 11,\n    layout: {\n      'text-field': '{point_count_abbreviated}',\n      'text-size': 10,\n    },\n  });\n\n  map.addLayer({\n    id: 'checkins',\n    type: 'circle',\n    source: 'checkins',\n    minzoom: 8,\n    filter: ['!has', 'point_count'],\n    paint: {\n      'circle-radius': 3,\n      'circle-color': color,\n      'circle-opacity': .9,\n      'circle-stroke-width': 3,\n      'circle-stroke-color': color,\n      'circle-stroke-opacity': .1,\n    },\n  });\n\n  map.once('data', () => {\n    requestAnimationFrame(() => {\n      renderNumber($infoCheckins, checkinsCount);\n      renderNumber($infoPlaces, placesCount);\n      renderNumber($infoCountries, countriesCount);\n      bodyClass.add('render');\n    });\n  });\n\n  map.on('mouseenter', 'cluster', () => {\n    map.getCanvas().style.cursor = 'pointer';\n  });\n\n  map.on('click', 'cluster', (e) => {\n    map.flyTo({\n      center: e.lngLat,\n      zoom: map.getZoom() + 2,\n    });\n  });\n\n  map.on('mouseleave', 'cluster', () => {\n    map.getCanvas().style.cursor = '';\n  });\n\n  map.addLayer({\n    id: 'lines',\n    type: 'line',\n    source: {\n      type: 'geojson',\n      data: {\n        type: 'Feature',\n        geometry: {\n          type: 'MultiLineString',\n          coordinates: lines,\n        },\n      },\n    },\n    layout: {\n      visibility: 'none',\n    },\n    paint: {\n      'line-color': \"#fff\",\n      'line-opacity': .3,\n    },\n  });\n\n  const filterByDate = (startDate, endDate) => {\n    map.setFilter('checkins', [\n      'all',\n      ['>=', 'date', startDate],\n      ['<=', 'date', endDate],\n      map.getFilter('checkins'),\n    ]);\n  };\n  // TODO: filter by date\n  // filterByDate(20160101, 20161212);\n});\n","var index = typeof fetch=='function' ? fetch.bind() : function(url, options) {\n\toptions = options || {};\n\treturn new Promise( function (resolve, reject) {\n\t\tvar request = new XMLHttpRequest();\n\n\t\trequest.open(options.method || 'get', url);\n\n\t\tfor (var i in options.headers) {\n\t\t\trequest.setRequestHeader(i, options.headers[i]);\n\t\t}\n\n\t\trequest.withCredentials = options.credentials=='include';\n\n\t\trequest.onload = function () {\n\t\t\tresolve(response());\n\t\t};\n\n\t\trequest.onerror = reject;\n\n\t\trequest.send(options.body);\n\n\t\tfunction response() {\n\t\t\tvar keys = [],\n\t\t\t\tall = [],\n\t\t\t\theaders = {},\n\t\t\t\theader;\n\n\t\t\trequest.getAllResponseHeaders().replace(/^(.*?):\\s*([\\s\\S]*?)$/gm, function (m, key, value) {\n\t\t\t\tkeys.push(key = key.toLowerCase());\n\t\t\t\tall.push([key, value]);\n\t\t\t\theader = headers[key];\n\t\t\t\theaders[key] = header ? (header + \",\" + value) : value;\n\t\t\t});\n\n\t\t\treturn {\n\t\t\t\tok: (request.status/200|0) == 1,\t\t// 200-299\n\t\t\t\tstatus: request.status,\n\t\t\t\tstatusText: request.statusText,\n\t\t\t\turl: request.responseURL,\n\t\t\t\tclone: response,\n\t\t\t\ttext: function () { return Promise.resolve(request.responseText); },\n\t\t\t\tjson: function () { return Promise.resolve(request.responseText).then(JSON.parse); },\n\t\t\t\tblob: function () { return Promise.resolve(new Blob([request.response])); },\n\t\t\t\theaders: {\n\t\t\t\t\tkeys: function () { return keys; },\n\t\t\t\t\tentries: function () { return all; },\n\t\t\t\t\tget: function (n) { return headers[n.toLowerCase()]; },\n\t\t\t\t\thas: function (n) { return n.toLowerCase() in headers; }\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t});\n};\n\nexport default index;\n//# sourceMappingURL=unfetch.es.js.map\n"],"names":["startInteractive","add","endInteractive","remove","renderNumber","el","number","render","num","inc","textContent","numberWithCommas","Math","ceil","index","fetch","bind","url","options","Promise","resolve","reject","response","header","keys","all","headers","request","getAllResponseHeaders","replace","m","key","value","push","toLowerCase","ok","status","statusText","responseURL","clone","text","responseText","json","then","JSON","parse","blob","Blob","entries","get","n","has","XMLHttpRequest","open","method","i","setRequestHeader","withCredentials","credentials","onload","onerror","send","body","mapboxgl","supported","accessToken","map","Map","touchZoomRotate","disableRotation","document","getElementById","$infoCountries","$infoPlaces","$infoCheckins","$countries","bodyClass","classList","on","addEventListener","toggle","x","toString","addControl","AttributionControl","compact","LayersControl","container","createElement","className","linesButton","innerHTML","type","title","getLayoutProperty","setLayoutProperty","appendChild","NavigationControl","data","_countries","_places","checkinsCount","features","length","lines","filter","f","properties","id","country","isUnique","geometry","coordinates","lat","lng","cc","LngLatBounds","bounds","extend","places_count","checkins_count","nextFeature","date","nextLat","nextLng","placesCount","Object","countries","c","countriesCount","sort","a","b","forEach","name","$button","e","fitBounds","padding","addSource","addLayer","zoom","once","getCanvas","style","cursor","flyTo","lngLat","getZoom"],"mappings":"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"}